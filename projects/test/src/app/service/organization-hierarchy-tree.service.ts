import { Injectable} from '@angular/core';
import { TreeItem, TreeviewItem } from 'ngx-treeview';

import {Node, NodeTree} from '../model/node.model';
import json from '../../../../../tree-mock.json';
@Injectable({
  providedIn: 'root'
})

export class OrganizationHierarchyTreeService {

  item: TreeviewItem[] = [];

  constructor() {
    this.buildTree();
   }

  buildTree(): void{

    // 1. build a simple array, which contains less information
    const nodes: NodeTree[] = [];
    const trees: TreeItem[] = [];

    json.data.forEach(el => {

      const nodeElement: Node = {
        id:     el.id,
        name:   el.attributes.name ?? 'unknwown',
        description: el.attributes.description ?? 'unknown',
        organization: el.relationships.organization.data.id
      };

      const nodeTree: NodeTree = {
        id:     el.id,
        node:   nodeElement,
        parentId: !el.relationships.parentNode.data
        ? 'unknown'
        : el.relationships.parentNode.data.id,
        children: []
      };

      const item = this.mapTreeViewItem(nodeElement);

      trees.push(item);
      nodes.push(nodeTree);
    });

    const mapIds = {};

    // initialize the map for the correct assignment
    for (let i = 0, l = nodes.length; i < l; i += 1) {
      mapIds[nodes[i].id] = i;
    }

    // creating the organization hierarchy-tree as object
    for (let i = 0, l = nodes.length; i < l; i += 1) {

      const nodeTree: NodeTree = nodes[i];
      const treeItem: TreeItem = trees[i];

      if (nodeTree.parentId !== 'unknown') {

        trees[mapIds[nodeTree.parentId]].children.push(treeItem);

      } else {

        this.item.push(new TreeviewItem(treeItem));
      }
    }
  }

  mapTreeViewItem(node: Node): TreeItem {

    return {
      text: node.name ?? 'unknown',
      value: node,
      collapsed: false,
      children: [],
      checked: false,
      disabled: false,
    };
  }

  getOrganizationHierarchy(): TreeviewItem[]{

    return this.item;
  }
}
